$(document).ready(function () {

// Reload the fileuploader
var item = '<div class="col-md-12 right-col btn btn-default js-fileapi-wrapper btn-large upload-image" id="bidUpload" style="padding:0px;display:none;"><div class="js-browse" style="margin-top:78px;"><span class="btn-txt" style="font-size:42px;color:#e8e8e8">+</span><input  class="click-pic" title="Click here to upload your photo" type="file" name="file"></div><div class="js-upload" style="height:31px;">'
+'<div class="progress progress-success" style="position:relative;height:30px;"><div class="js-progress bar" style="position:absolute;height:30px;padding-top:30px;"></div></div></div></div><div class="clearfix"></div><a class="btn btn-default profile-remove-media" style="display:none !important;">Remove Media</a>';
function LoadUploader(){

	$("#FileLoader").html(item);

  var url = '/' + service + '/' + identifier + '/upload';

  //This is used in the routes.php laravel

  $("#FileLoader").find("#bidUpload").fileapi({
    url: url,
    multiple: !1,
    autoUpload: !0,
    imageAutoOrientation: true,
    imageTransform: {
      rotate: 'auto'
    },
    maxSize: FileAPI.MB * 100,
    elements: {
      size: ".js-size",
      active: {
        show: ".js-upload",
        hide: ".js-browse"
      },
      progress: ".js-progress"
    },
    accept: "image/*,video/*,video/mp4,audio/*",
    headers: {
      "X-CSRF-Token": $("input[name=_token]").attr("value")
    },
    onSelect: function (evt, data) {
      $('img#theImg').remove();
      $('.bid-video').remove();
    },
    onProgress: function (a, b) {
      //disable upload button while processing
      $('.upload-disable-btn').attr('disabled', 'disabled');
    },
    onComplete: function (a, b) {
      //alert(fileExtension);
      var img = '/bids_images/'+b.result;
      //alert(img);
      //alert(b.result);
      if (b.files[0].size > 104857600) {
        $('.error-help').text('Size is too large');
      }
      else if ($.inArray(b.files[0].type, [
            'image/jpg',
            'image/png',
            'image/gif',
            'image/jpeg',
            'video/mp4',
            'video/quicktime',
            'video/mpeg',
            'video/flv',
            'video/x-flv',
            'audio/mp3',
            'audio/mpeg'
          ]) == -1) {
        $('.error-help').text('This format is not supported');
      }
      else {
        $('.error-help').text('');
        $('.upload-disable-btn').removeAttr('disabled');
        $('#bidUpload .js-browse .btn-txt').css('display', 'none');
        $('#bidUpload .js-browse .click-pic').css('display', 'none');
        var img_or_video = '/bids_images/' + b.result;

        //Set array of vaiablr for Image and Video
        var img = ['jpg', 'png', 'gif', 'jpeg'];
        var vid = ['mp4', 'mov', 'mpg', 'flv'];
        var sound = ['mp3','mpeg'];

        //Get File Extention
        //alert(JSON.stringify(b, null, 4));
        var fileName = b.result;
        if(fileName == "Unauthorized."){ 
        		   
        		$("#LoginModal").modal('show');
        	 	return false;
        }
        var fileExtension = fileName.substr((fileName.lastIndexOf('.') + 1)).toLowerCase();
        //alert(fileExtension);
        $('.profile-box .upload-image img:eq(0)').attr('src', img_or_video).remove();
        $('.js-browse').css('margin-top', '5');
        //Check if extention is image then display Image otherwise Display Video
        if ($.inArray(fileExtension, img) !== -1) {

          $('.profile-box .upload-image').prepend('<img id="theImg" src="' + img_or_video + '" height="105"/>');

          //Append Input field in create bid form
          $('<input>').attr({
            type: 'hidden',
            name: 'file_temp_name',
            value: b.result,
          }).appendTo('form.create-bid-form');

        } else if ($.inArray(fileExtension, sound) !== -1) {

          $('.profile-box .upload-image').prepend('<audio id="audio_example" class="video-js vjs-default-skin" controls preload="auto" poster="/assets/images/poster-audio.png" width="600" height="600" data-setup="{}"><source src="' + img_or_video + '" type="audio/mp3"/></audio>');

          //Append Input field in crete bid form
          $('<input>').attr({
            type: 'hidden',
            name: 'file_temp_name',
            value: b.result,
          }).appendTo('form.create-bid-form');

        }else if (b.result.indexOf('amazonaws') !== -1) {


				var counter = 0;
          	var responseSplit = b.result.split('--id--');
          	var videoUrl = responseSplit[0];
          	var videoId = responseSplit[1];
          	var videofile = videoUrl.split(".");
          	var file = videoUrl.substr( (videoUrl.lastIndexOf('.') +1) ).split('?');
          	var extension = file[0];

         	$('.profile-box .upload-image').html("<div class='temporaryVideo' style='background: #000 url(/assets/images/ajax-loader.gif) no-repeat center center; width: 280px; height: 180px; margin: 0 auto !important;'></div>")

				if(extension == "mp3"){
					var $videoJs ='<div class="flex-video"><audio poster="/assets/images/poster-audio.png" id="example_video_1" class="bid-video video-js vjs-default-skin vjs-big-play-centered" controls preload="auto" height="180" width="280" style="margin-left:auto;margin-right:auto;background-color: #FFF;">' +
              '<source src="' + videoUrl + '"  type="audio/mp3">' +
              '</audio></div>';
				} else {
					var $videoJs ='<div class="flex-video"><video id="example_video_1" class="bid-video video-js vjs-default-skin vjs-big-play-centered" controls preload="auto" height="180" width="280" style="margin-left:auto;margin-right:auto;background-color: #FFF;">' +
              '<source src="' + videoUrl + '">' +
              '</video></div>';
            }

          //Append Input field in crete bid form
          $('<input>').attr({
            type: 'hidden',
            name: 'file_temp_name',
            value: videoUrl,
          }).appendTo('form.create-bid-form');

          $('<input>').attr({
            type: 'hidden',
            name: 'file_temp_zencodeid',
            value: videoId,
          }).appendTo('form.create-bid-form');

				counter=0;

          (function (videoId) {

            var encodeInterval = setInterval(function () {

              $.ajax({
                method: "GET",
                url: "/encode-status",
                data: { jobId: videoId }
              })
              .done(function( result ) {
                if (result == 'finished' && counter==0) {
                	counter=1;
                  clearInterval(encodeInterval);
                  $('.profile-box .upload-image').html($videoJs);
                  videojs($('.profile-box .upload-image').find("#example_video_1"), {"example_option": true,"controls": true, "autoplay": false, "preload": "auto"}, function () {});
                  $(".vjs-error-display").hide();
                } else if(result == 'failed') {
                  clearInterval(encodeInterval);
                }
              });

            }, 2000);

          })(videoId);

          /*videojs('example_video_1', {"example_option": true}, function () {
          });*/

        }

        else {
        //mobile upload


        }

        //Remove border error is added
        $('#profile .profile-box .comment-container .upload-image').css('border', '1px solid #fff !important');

        $('.profile-box .profile-remove-media').css('display', 'block !important');
      }
    }

  });

    $('.profile-remove-media').bind('click', function () {
    $('img#theImg,.temporaryVideo,.bid-video,video,#example_video_1').remove();
    $('#bidUpload .js-browse .btn-txt').css('display', 'block');
    $('#bidUpload .js-browse .click-pic').css('display', 'block');
    $('.js-browse').css('margin-top', '78px');
    $('form.create-bid-form').find('input[name="file_temp_name"]').remove();
    $('form.create-bid-form').find('input[name="file_temp_zencodeid"]').remove();
    LoadUploader();
    encodeInterval = "";
    $("#bidUpload").show();
    $(this).hide();
    return false;
  });


}/* END of FUNCTION */
 LoadUploader();

});

